<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pronostici - Sistema Completo</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

// ‚ö†Ô∏è SOSTITUISCI QUESTI VALORI CON I TUOI DA SUPABASE
const SUPABASE_URL = 'https://jhquweahxrixlxdolpwc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpocXV3ZWFoeHJpeGx4ZG9scHdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDYxMTksImV4cCI6MjA4MDAyMjExOX0.UGA3_cqQvzXC79gKsceFnmqrCnOy1cjJQ7uEKLE0K3c';
const ADMIN_USER_ID = '1b2932fe-9d8e-4518-a8cf-79ae5cf98bcd';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Database stemmi squadre
const STEMMI_SQUADRE = {
  'AC Milan': 'https://media.api-sports.io/football/teams/489.png',
  'Milan': 'https://media.api-sports.io/football/teams/489.png',
  'AS Roma': 'https://media.api-sports.io/football/teams/497.png',
  'Roma': 'https://media.api-sports.io/football/teams/497.png',
  'Atalanta': 'https://media.api-sports.io/football/teams/499.png',
  'Bologna': 'https://media.api-sports.io/football/teams/500.png',
  'Cagliari': 'https://media.api-sports.io/football/teams/490.png',
  'Como': 'https://static.flashscore.com/res/image/data/Cf5pQNyS-hpmw8K1h.png',
  'Cremonese': 'https://static.flashscore.com/res/image/data/EDUhUrDr-t4GQxEM5.png',
  'Fiorentina': 'https://media.api-sports.io/football/teams/502.png',
  'Genoa': 'https://media.api-sports.io/football/teams/495.png',
  'Inter': 'https://media.api-sports.io/football/teams/505.png',
  'Juventus': 'https://static.flashscore.com/res/image/data/CbDOFGyS-EXzXDYgS.png',
  'Lazio': 'https://media.api-sports.io/football/teams/487.png',
  'Lecce': 'https://media.api-sports.io/football/teams/867.png',
  'Napoli': 'https://media.api-sports.io/football/teams/492.png',
  'Parma': 'https://static.flashscore.com/res/image/data/YcrE7ae5-fydXzLY6.png',
  'Pisa': 'https://static.flashscore.com/res/image/data/CzC5XtGG-GMOw3SI3.png',
  'Sassuolo': 'https://media.api-sports.io/football/teams/488.png',
  'Torino': 'https://media.api-sports.io/football/teams/503.png',
  'Udinese': 'https://media.api-sports.io/football/teams/494.png',
  'Verona': 'https://media.api-sports.io/football/teams/504.png',
  'Hellas Verona': 'https://media.api-sports.io/football/teams/504.png',
  
  // === SERIE B ===
  'Avellino': 'https://static.flashscore.com/res/image/data/dluUXyRq-zyayiEr5.png',
  'Bari': 'https://static.flashscore.com/res/image/data/OCZAFtU0-dYPMS6QG.png',
  'Carrarese': 'https://static.flashscore.com/res/image/data/lf1fmHoe-KfFUyYyC.png',
  'Catanzaro': 'https://static.flashscore.com/res/image/data/CITDXu8k-O6dImjhL.png',
  'Cesena': 'https://static.flashscore.com/res/image/data/t6U8jIT0-YB20ndi2.png',
  'Empoli': 'https://static.flashscore.com/res/image/data/8ftWPVPq-KbH8aCLf.png',
  'Entella': 'https://static.flashscore.com/res/image/data/hbM9tPVH-EcAnNUJp.png',
  'Virtus Entella': 'https://static.flashscore.com/res/image/data/hbM9tPVH-EcAnNUJp.png',
  'Frosinone': 'https://static.flashscore.com/res/image/data/p0q5GtjC-t4GQxEM5.png',
  'Juve Stabia': 'https://static.flashscore.com/res/image/data/299kpoiT-xrK1g9MA.png',
  'Mantova': 'https://static.flashscore.com/res/image/data/GSnwGvWH-4vkZ9lY0.png',
  'Modena': 'https://static.flashscore.com/res/image/data/nq8HIa5k-OY47DkeT.png',
  'Monza': 'https://static.flashscore.com/res/image/data/Mk897YAN-8zvPU7k3.png',
  'Padova': 'https://static.flashscore.com/res/image/data/C0Gf1Pne-0lwy4Ij1.png',
  'Palermo': 'https://static.flashscore.com/res/image/data/nkpmxOBN-fL3dmxxd.png',
  'Pescara': 'https://static.flashscore.com/res/image/data/YP7Usg8k-MuBSTKf8.png',
  'Reggiana': 'https://static.flashscore.com/res/image/data/h4Rp5mAN-xpwwMV0F.png',
  'Sampdoria': 'https://static.flashscore.com/res/image/data/WQp3CvUH-WdmUvPiG.png',
  'Spezia': 'https://static.flashscore.com/res/image/data/08qns8VH-zJVdqELi.png',
  'Sudtirol': 'https://static.flashscore.com/res/image/data/2Xf8oTjT-UJeBD3ZT.png',
  'S√ºdtirol': 'https://static.flashscore.com/res/image/data/2Xf8oTjT-UJeBD3ZT.png',
  'Venezia': 'https://static.flashscore.com/res/image/data/4lQfQQmC-AX567M6G.png',

  // === PREMIER ===
  'Arsenal': 'https://static.flashscore.com/res/image/data/0n1ffK6k-vcNAdtF9.png',
  'Aston Villa': 'https://static.flashscore.com/res/image/data/UHchCEVH-UTYC4Dd6.png',
  'Bournemouth': 'https://static.flashscore.com/res/image/data/C60HMWTH-tCGtX12c.png',
  'Brentford': 'https://static.flashscore.com/res/image/data/SjSCLv86-r9Mudk7j.png',
  'Brighton': 'https://static.flashscore.com/res/image/data/G0q9xjRq-b92lfEJC.png',
  'Burnley': 'https://static.flashscore.com/res/image/data/xO3nES96-6PhTI7J6.png',
  'Chelsea': 'https://static.flashscore.com/res/image/data/lMxEQ8me-IROrZEJb.png',
  'Crystal Palace': 'https://static.flashscore.com/res/image/data/GfkvlLmC-pzMOQXRe.png',
  'Everton': '	https://static.flashscore.com/res/image/data/EBfZuwme-bRmKmISE.png',
  'Fulham': 'https://static.flashscore.com/res/image/data/fkbYUWme-ImMEe0UF.png',
  'Leeds': 'https://static.flashscore.com/res/image/data/lvs4WW5k-MTp25XgE.png',
  'Liverpool': 'https://static.flashscore.com/res/image/data/nBClzyne-f97XIGZs.png',
  'Manchester City': 'https://static.flashscore.com/res/image/data/0vgscFU0-lQuhqN8N.png',
  'Manchester Utd': 'https://static.flashscore.com/res/image/data/GhGV3qjT-UPrTWfIe.png',
  'Newcastle': 'https://static.flashscore.com/res/image/data/UXo7VXPq-ImMEe0UF.png',
  'Nottingham': 'https://static.flashscore.com/res/image/data/86ODdyle-ImKwLTtA.png',
  'Sunderland': 'https://static.flashscore.com/res/image/data/rPPdotBN-0d34NJCO.png',
  'Tottenham': 'https://static.flashscore.com/res/image/data/v3SzDxVH-Ig5FKJZ5.png',
  'West Ham': '	https://static.flashscore.com/res/image/data/YeSfKGlC-Q9DJHs4l.png',
  'Wolves': 'https://static.flashscore.com/res/image/data/OMUzjDkC-CjV6Eptm.png'
  };

function getStemmaSquadra(nomeSquadra) {
  if (!nomeSquadra) return null;
  const nome = nomeSquadra.trim();
  if (STEMMI_SQUADRE[nome]) return STEMMI_SQUADRE[nome];
  for (const [key, value] of Object.entries(STEMMI_SQUADRE)) {
    if (nome.includes(key) || key.includes(nome)) return value;
  }
  return null;
}

const CAMPIONATI = [
  { id: 'serie-a', nome: 'Serie A (Italia)', emoji: 'üáÆüáπ', logo: 'https://media.api-sports.io/football/leagues/135.png' },
  { id: 'serie-b', nome: 'Serie B (Italia)', emoji: 'üáÆüáπ', logo: 'https://media.api-sports.io/football/leagues/136.png' },
  { id: 'premier-league', nome: 'Premier League', emoji: 'üè¥', logo: 'https://media.api-sports.io/football/leagues/39.png' },
  { id: 'la-liga', nome: 'La Liga', emoji: 'üá™üá∏', logo: 'https://media.api-sports.io/football/leagues/140.png' },
  { id: 'bundesliga', nome: 'Bundesliga', emoji: 'üá©üá™', logo: 'https://media.api-sports.io/football/leagues/78.png' },
  { id: 'ligue-1', nome: 'Ligue 1', emoji: 'üá´üá∑', logo: 'https://media.api-sports.io/football/leagues/61.png' }
];

function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  // Stati esistenti
  const [campionatoSelezionato, setCampionatoSelezionato] = useState('serie-a');
  const [dataSelezionata, setDataSelezionata] = useState(new Date().toISOString().split('T')[0]);
  const [pronostici, setPronostici] = useState([]);
  const [partiteDisponibili, setPartiteDisponibili] = useState([]);
  const [vistaCorrente, setVistaCorrente] = useState('giorno');
  
  // Nuovi stati per Multiple e Budget
  const [sezioneAttiva, setSezioneAttiva] = useState('singole'); // 'singole', 'multiple', 'budget', 'crea-multipla'
  const [budget, setBudget] = useState(null);
  const [movimenti, setMovimenti] = useState([]);
  const [multiple, setMultiple] = useState([]);
  const [nuovaMultipla, setNuovaMultipla] = useState({
    nome: '',
    importo: '',
    pronostici: []
  });
  const [loginData, setLoginData] = useState({ email: '', password: '' });
  const [mostraRegistrazione, setMostraRegistrazione] = useState(false);
  
  // Gestione partite per multipla (tutti i campionati, tutte le date)
  const [tutteLePartite, setTutteLePartite] = useState([]);
  const [filtriMultipla, setFiltriMultipla] = useState({
    campionato: 'tutti',
    dataInizio: '',
    dataFine: ''
  });

  useEffect(() => {
    checkUser();
    const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
      setUser(session?.user || null);
    });
    return () => authListener?.subscription?.unsubscribe();
  }, []);

  useEffect(() => {
    if (user) {
      caricaPronostici();
      caricaPartite();
      caricaBudget();
      caricaMovimenti();
      caricaMultiple();
      caricaTutteLePartite();
    }
  }, [campionatoSelezionato, dataSelezionata, vistaCorrente, user]);

  async function checkUser() {
    const { data: { session } } = await supabase.auth.getSession();
    setUser(session?.user || null);
    setLoading(false);
  }

  const isAdmin = user?.id === ADMIN_USER_ID;

  async function login(e) {
    e.preventDefault();
    try {
      const { error } = await supabase.auth.signInWithPassword(loginData);
      if (error) throw error;
    } catch (error) {
      alert('Errore login: ' + error.message);
    }
  }

  async function registrazione(e) {
    e.preventDefault();
    try {
      const { error } = await supabase.auth.signUp({
        email: loginData.email,
        password: loginData.password
      });
      if (error) throw error;
      alert('Registrazione completata! Ora puoi accedere.');
      setMostraRegistrazione(false);
    } catch (error) {
      alert('Errore registrazione: ' + error.message);
    }
  }

  async function logout() {
    await supabase.auth.signOut();
  }

  // ========== BUDGET ==========
  async function caricaBudget() {
    try {
      const { data, error } = await supabase
        .from('budget')
        .select('*')
        .eq('user_id', user.id)
        .single();
      
      if (error && error.code !== 'PGRST116') throw error;
      
      if (!data) {
        // Crea budget iniziale
        const { data: newBudget, error: insertError } = await supabase
          .from('budget')
          .insert([{ user_id: user.id, saldo_iniziale: 0, saldo_attuale: 0 }])
          .select()
          .single();
        if (insertError) throw insertError;
        setBudget(newBudget);
      } else {
        setBudget(data);
      }
    } catch (error) {
      console.error('Errore caricamento budget:', error.message);
    }
  }

  async function aggiungiMovimento(tipo, importo, descrizione) {
    try {
      const { error } = await supabase.from('movimenti').insert([{
        user_id: user.id,
        tipo,
        importo,
        descrizione
      }]);
      if (error) throw error;

      // Aggiorna saldo
      let nuovoSaldo = budget.saldo_attuale;
      if (tipo === 'deposito' || tipo === 'vincita' || tipo === 'rimborso') {
        nuovoSaldo += parseFloat(importo);
      } else if (tipo === 'prelievo' || tipo === 'puntata') {
        nuovoSaldo -= parseFloat(importo);
      }

      const { error: updateError } = await supabase
        .from('budget')
        .update({ saldo_attuale: nuovoSaldo })
        .eq('user_id', user.id);
      
      if (updateError) throw updateError;

      caricaBudget();
      caricaMovimenti();
    } catch (error) {
      alert('Errore: ' + error.message);
    }
  }

  async function caricaMovimenti() {
    try {
      const { data, error } = await supabase
        .from('movimenti')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false })
        .limit(50);
      if (error) throw error;
      setMovimenti(data || []);
    } catch (error) {
      console.error('Errore caricamento movimenti:', error.message);
    }
  }

  // ========== PRONOSTICI SINGOLI ==========
  async function caricaPronostici() {
    try {
      setLoading(true);
      let query = supabase.from('pronostici').select('*').eq('campionato', campionatoSelezionato);
      if (vistaCorrente === 'giorno') {
        query = query.eq('data_partita', dataSelezionata);
      }
      const { data, error } = await query.order('created_at', { ascending: false });
      if (error) throw error;
      setPronostici(data || []);
    } catch (error) {
      console.error('Errore caricamento pronostici:', error.message);
    } finally {
      setLoading(false);
    }
  }

  async function aggiungiPronosticoSingolo(partitaId, tipoPronostico, importoPuntata) {
    if (!importoPuntata || parseFloat(importoPuntata) <= 0) {
      alert('Inserisci un importo valido!');
      return;
    }

    const importo = parseFloat(importoPuntata);
    if (importo > budget.saldo_attuale) {
      alert('Saldo insufficiente!');
      return;
    }

    const partita = partiteDisponibili.find(p => p.id === partitaId);
    if (!partita) return;

    const nomePartita = `${partita.squadra_casa} vs ${partita.squadra_trasferta}`;
    let quota = 0;
    let label = '';

    switch(tipoPronostico) {
      case '1': quota = partita.quota_1; label = '1 (Casa)'; break;
      case 'X': quota = partita.quota_x; label = 'X (Pareggio)'; break;
      case '2': quota = partita.quota_2; label = '2 (Trasferta)'; break;
      case 'GOL': quota = partita.quota_gol; label = 'Gol'; break;
      case 'NOGOL': quota = partita.quota_nogol; label = 'No Gol'; break;
      case 'OVER25': quota = partita.quota_over_25; label = 'Over 2.5'; break;
      case 'UNDER25': quota = partita.quota_under_25; label = 'Under 2.5'; break;
      case '1X': quota = partita.quota_1x; label = '1X'; break;
      case '12': quota = partita.quota_12; label = '12'; break;
      case 'X2': quota = partita.quota_x2; label = 'X2'; break;
    }

    if (!quota) {
      alert('Quota non disponibile');
      return;
    }

    try {
      // Aggiungi pronostico
      const { error } = await supabase.from('pronostici').insert([{
        partita: nomePartita,
        pronostico: label,
        quota: quota,
        importo_puntata: importo,
        guadagno_netto: (quota * importo) - importo,
        stato: 'pending',
        campionato: partita.campionato,
        data_partita: partita.data_partita,
        user_id: user.id,
        partita_id: partita.id
      }]);
      if (error) throw error;

      // Registra movimento
      await aggiungiMovimento('puntata', importo, `Singola: ${nomePartita} - ${label}`);
      
      caricaPronostici();
      alert('‚úÖ Pronostico singolo aggiunto!');
    } catch (error) {
      alert('Errore: ' + error.message);
    }
  }

  async function aggiornaStatoSingolo(id, nuovoStato) {
    try {
      const pronostico = pronostici.find(p => p.id === id);
      if (!pronostico) return;

      const { error } = await supabase
        .from('pronostici')
        .update({ stato: nuovoStato })
        .eq('id', id);
      if (error) throw error;

      // Se vinto, aggiungi vincita al budget
      if (nuovoStato === 'win') {
        const vincita = pronostico.quota * pronostico.importo_puntata;
        await aggiungiMovimento('vincita', vincita, `Vincita singola: ${pronostico.partita}`);
      }

      caricaPronostici();
    } catch (error) {
      console.error('Errore aggiornamento:', error.message);
    }
  }

  // ========== MULTIPLE ==========
  async function caricaMultiple() {
    try {
      const { data, error } = await supabase
        .from('multiple')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });
      if (error) throw error;

      // Carica anche i pronostici di ogni multipla
      const multipleConPronostici = await Promise.all(
        (data || []).map(async (multipla) => {
          const { data: pronostici, error: errPronostici } = await supabase
            .from('pronostici_multiple')
            .select('*')
            .eq('multipla_id', multipla.id);
          
          return {
            ...multipla,
            pronostici: pronostici || []
          };
        })
      );

      setMultiple(multipleConPronostici);
    } catch (error) {
      console.error('Errore caricamento multiple:', error.message);
    }
  }

  async function caricaTutteLePartite() {
    try {
      const { data, error } = await supabase
        .from('partite')
        .select('*')
        .order('data_partita', { ascending: true });
      if (error) throw error;
      setTutteLePartite(data || []);
    } catch (error) {
      console.error('Errore caricamento partite:', error.message);
    }
  }

  function aggiungiPronosticoAMultipla(partita, tipoPronostico) {
    let quota = 0;
    let label = '';

    switch(tipoPronostico) {
      case '1': quota = partita.quota_1; label = '1'; break;
      case 'X': quota = partita.quota_x; label = 'X'; break;
      case '2': quota = partita.quota_2; label = '2'; break;
      case 'GOL': quota = partita.quota_gol; label = 'Gol'; break;
      case 'NOGOL': quota = partita.quota_nogol; label = 'NG'; break;
      case 'OVER25': quota = partita.quota_over_25; label = 'O2.5'; break;
      case 'UNDER25': quota = partita.quota_under_25; label = 'U2.5'; break;
      case '1X': quota = partita.quota_1x; label = '1X'; break;
      case '12': quota = partita.quota_12; label = '12'; break;
      case 'X2': quota = partita.quota_x2; label = 'X2'; break;
    }

    if (!quota) {
      alert('Quota non disponibile');
      return;
    }

    // Verifica se gi√† presente
    const giaPresente = nuovaMultipla.pronostici.some(p => p.partita_id === partita.id);
    if (giaPresente) {
      alert('Partita gi√† presente nella multipla!');
      return;
    }

    setNuovaMultipla(prev => ({
      ...prev,
      pronostici: [...prev.pronostici, {
        partita_id: partita.id,
        partita_nome: `${partita.squadra_casa} vs ${partita.squadra_trasferta}`,
        campionato: partita.campionato,
        data_partita: partita.data_partita,
        pronostico: label,
        quota: quota
      }]
    }));
  }

  function rimuoviPronosticoDaMultipla(index) {
    setNuovaMultipla(prev => ({
      ...prev,
      pronostici: prev.pronostici.filter((_, i) => i !== index)
    }));
  }

  function calcolaQuotaTotale() {
    if (nuovaMultipla.pronostici.length === 0) return 1;
    return nuovaMultipla.pronostici.reduce((acc, p) => acc * p.quota, 1).toFixed(2);
  }

  function calcolaGuadagnoPotenziale() {
    const importo = parseFloat(nuovaMultipla.importo) || 0;
    const quotaTotale = parseFloat(calcolaQuotaTotale());
    return (importo * quotaTotale).toFixed(2);
  }

  async function salvaMultipla() {
    if (!nuovaMultipla.nome.trim()) {
      alert('Inserisci un nome per la multipla!');
      return;
    }

    if (nuovaMultipla.pronostici.length < 2) {
      alert('Servono almeno 2 pronostici per una multipla!');
      return;
    }

    const importo = parseFloat(nuovaMultipla.importo);
    if (!importo || importo <= 0) {
      alert('Inserisci un importo valido!');
      return;
    }

    if (importo > budget.saldo_attuale) {
      alert('Saldo insufficiente!');
      return;
    }

    try {
      const quotaTotale = parseFloat(calcolaQuotaTotale());
      const guadagnoPotenziale = parseFloat(calcolaGuadagnoPotenziale());
      const guadagnoNetto = guadagnoPotenziale - importo;

      // Crea multipla
      const { data: multipla, error: errorMultipla } = await supabase
        .from('multiple')
        .insert([{
          user_id: user.id,
          nome: nuovaMultipla.nome,
          quota_totale: quotaTotale,
          importo_puntata: importo,
          guadagno_potenziale: guadagnoPotenziale,
          guadagno_netto: guadagnoNetto,
          stato: 'pending'
        }])
        .select()
        .single();

      if (errorMultipla) throw errorMultipla;

      // Aggiungi pronostici alla multipla
      const pronosticiDaInserire = nuovaMultipla.pronostici.map(p => ({
        multipla_id: multipla.id,
        partita_id: p.partita_id,
        pronostico: p.pronostico,
        quota: p.quota,
        partita_nome: p.partita_nome,
        campionato: p.campionato,
        data_partita: p.data_partita,
        stato: 'pending'
      }));

      const { error: errorPronostici } = await supabase
        .from('pronostici_multiple')
        .insert(pronosticiDaInserire);

      if (errorPronostici) throw errorPronostici;

      // Registra movimento
      await aggiungiMovimento('puntata', importo, `Multipla: ${nuovaMultipla.nome}`);

      // Reset form
      setNuovaMultipla({ nome: '', importo: '', pronostici: [] });
      setSezioneAttiva('multiple');
      caricaMultiple();
      alert('‚úÖ Multipla creata con successo!');
    } catch (error) {
      alert('Errore: ' + error.message);
    }
  }

  async function aggiornaStatoMultipla(multiplaId, nuovoStato) {
    try {
      const multipla = multiple.find(m => m.id === multiplaId);
      if (!multipla) return;

      const { error } = await supabase
        .from('multiple')
        .update({ stato: nuovoStato })
        .eq('id', multiplaId);
      if (error) throw error;

      // Se vinta, aggiungi vincita
      if (nuovoStato === 'win') {
        await aggiungiMovimento('vincita', multipla.guadagno_potenziale, `Vincita multipla: ${multipla.nome}`);
      }

      caricaMultiple();
    } catch (error) {
      console.error('Errore aggiornamento multipla:', error.message);
    }
  }

  async function eliminaMultipla(id) {
    if (!confirm('Eliminare questa multipla?')) return;
    try {
      const { error } = await supabase.from('multiple').delete().eq('id', id);
      if (error) throw error;
      caricaMultiple();
    } catch (error) {
      console.error('Errore eliminazione:', error.message);
    }
  }

  // ========== PARTITE ==========
  async function caricaPartite() {
    try {
      let query = supabase.from('partite').select('*').eq('campionato', campionatoSelezionato);
      if (vistaCorrente === 'giorno') {
        query = query.eq('data_partita', dataSelezionata);
      }
      const { data, error } = await query.order('data_partita', { ascending: true });
      if (error) throw error;
      setPartiteDisponibili(data || []);
    } catch (error) {
      console.error('Errore caricamento partite:', error.message);
    }
  }

  function scaricaTemplate() {
    const template = `SQUADRA_CASA\tSQUADRA_TRASFERTA\tCAMPIONATO\tDATA\tORARIO\tQUOTA_1\tQUOTA_X\tQUOTA_2\tQUOTA_NOGOL\tQUOTA_GOL\tQUOTA_UNDER_15\tQUOTA_OVER_15\tQUOTA_UNDER_25\tQUOTA_OVER_25\tQUOTA_UNDER_35\tQUOTA_OVER_35\tQUOTA_1X\tQUOTA_12\tQUOTA_X2
Inter\tMilan\tserie-a\t15/12/2024\t20:45\t2,10\t3,40\t3,50\t2,80\t1,40\t1,20\t4,50\t1,50\t2,60\t2,20\t1,65\t1,30\t1,25\t1,60`;
    
    const blob = new Blob([template], { type: 'text/tab-separated-values' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'template_partite.tsv';
    a.click();
    URL.revokeObjectURL(url);
  }

  async function importaExcel(file) {
    try {
      const text = await file.text();
      const lines = text.split('\n').filter(l => l.trim());
      const partite = [];
      const batchTimestamp = new Date().toISOString();

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split('\t');
        if (values.length < 19) continue;

        let dataSQL = values[3]?.trim();
        if (dataSQL && dataSQL.includes('/')) {
          const [giorno, mese, anno] = dataSQL.split('/');
          dataSQL = `${anno}-${mese.padStart(2, '0')}-${giorno.padStart(2, '0')}`;
        }

        const parseQuota = (val) => {
          if (!val) return null;
          const num = parseFloat(val.toString().trim().replace(',', '.'));
          return isNaN(num) ? null : num;
        };

        partite.push({
          squadra_casa: values[0]?.trim(),
          squadra_trasferta: values[1]?.trim(),
          campionato: values[2]?.trim(),
          data_partita: dataSQL,
          orario: values[4]?.trim() || null,
          quota_1: parseQuota(values[5]),
          quota_x: parseQuota(values[6]),
          quota_2: parseQuota(values[7]),
          quota_nogol: parseQuota(values[8]),
          quota_gol: parseQuota(values[9]),
          quota_under_15: parseQuota(values[10]),
          quota_over_15: parseQuota(values[11]),
          quota_under_25: parseQuota(values[12]),
          quota_over_25: parseQuota(values[13]),
          quota_under_35: parseQuota(values[14]),
          quota_over_35: parseQuota(values[15]),
          quota_1x: parseQuota(values[16]),
          quota_12: parseQuota(values[17]),
          quota_x2: parseQuota(values[18]),
          user_id: user.id,
          batch_importazione: batchTimestamp
        });
      }

      const { error } = await supabase.from('partite').insert(partite);
      if (error) throw error;

      alert(`‚úÖ ${partite.length} partite importate!`);
      caricaPartite();
      caricaTutteLePartite();
    } catch (error) {
      alert('Errore importazione: ' + error.message);
    }
  }

  function cambiaGiorno(direzione) {
    const d = new Date(dataSelezionata);
    d.setDate(d.getDate() + direzione);
    setDataSelezionata(d.toISOString().split('T')[0]);
  }

  function formattaData(data) {
    const d = new Date(data + 'T00:00:00');
    const oggi = new Date();
    oggi.setHours(0, 0, 0, 0);
    const domani = new Date(oggi);
    domani.setDate(domani.getDate() + 1);
    const dataOggetto = new Date(d);
    dataOggetto.setHours(0, 0, 0, 0);
    if (dataOggetto.getTime() === oggi.getTime()) return 'Oggi';
    if (dataOggetto.getTime() === domani.getTime()) return 'Domani';
    return d.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' });
  }

  const statistiche = {
    singole: {
      totali: pronostici.length,
      vinte: pronostici.filter(p => p.stato === 'win').length,
      perse: pronostici.filter(p => p.stato === 'loss').length,
      pending: pronostici.filter(p => p.stato === 'pending').length,
      incassato: pronostici.filter(p => p.stato === 'win').reduce((acc, p) => acc + (p.quota * p.importo_puntata), 0),
      speso: pronostici.reduce((acc, p) => acc + (p.importo_puntata || 0), 0)
    },
    multiple: {
      totali: multiple.length,
      vinte: multiple.filter(m => m.stato === 'win').length,
      perse: multiple.filter(m => m.stato === 'loss').length,
      pending: multiple.filter(m => m.stato === 'pending').length,
      incassato: multiple.filter(m => m.stato === 'win').reduce((acc, m) => acc + m.guadagno_potenziale, 0),
      speso: multiple.reduce((acc, m) => acc + m.importo_puntata, 0)
    }
  };

  const campionatoCorrente = CAMPIONATI.find(c => c.id === campionatoSelezionato);

  // Filtro partite per multipla
  const partiteFiltrate = tutteLePartite.filter(p => {
    if (filtriMultipla.campionato !== 'tutti' && p.campionato !== filtriMultipla.campionato) return false;
    if (filtriMultipla.dataInizio && p.data_partita < filtriMultipla.dataInizio) return false;
    if (filtriMultipla.dataFine && p.data_partita > filtriMultipla.dataFine) return false;
    return true;
  });

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <div className="text-2xl text-gray-600">Caricamento...</div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
          <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">‚öΩ Pronostici Pro</h1>
          
          {!mostraRegistrazione ? (
            <>
              <form onSubmit={login} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input
                    type="email"
                    value={loginData.email}
                    onChange={(e) => setLoginData({...loginData, email: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input
                    type="password"
                    value={loginData.password}
                    onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                  Accedi
                </button>
              </form>
              <button 
                onClick={() => setMostraRegistrazione(true)}
                className="w-full mt-3 text-blue-600 hover:underline text-sm"
              >
                Non hai un account? Registrati qui
              </button>
            </>
          ) : (
            <>
              <form onSubmit={registrazione} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input
                    type="email"
                    value={loginData.email}
                    onChange={(e) => setLoginData({...loginData, email: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Password (min 6 caratteri)</label>
                  <input
                    type="password"
                    value={loginData.password}
                    onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    minLength="6"
                    required
                  />
                </div>
                <button type="submit" className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                  Registrati
                </button>
              </form>
              <button 
                onClick={() => setMostraRegistrazione(false)}
                className="w-full mt-3 text-blue-600 hover:underline text-sm"
              >
                Hai gi√† un account? Accedi qui
              </button>
            </>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      <div className="container mx-auto px-4 py-8 max-w-7xl">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-8">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold text-gray-800 mb-2">‚öΩ Pronostici Pro</h1>
              <p className="text-gray-600">
                {isAdmin ? 'üëë Admin' : 'üë§ User'} | Saldo: <span className="font-bold text-green-600">‚Ç¨{budget?.saldo_attuale?.toFixed(2) || '0.00'}</span>
              </p>
            </div>
            <button onClick={logout} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
              Esci
            </button>
          </div>
        </div>

        {/* Menu Principale */}
        <div className="bg-white rounded-lg shadow-lg p-4 mb-8">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button
              onClick={() => setSezioneAttiva('singole')}
              className={`py-3 px-4 rounded-lg font-semibold transition ${
                sezioneAttiva === 'singole' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              üéØ Singole ({statistiche.singole.pending})
            </button>
            <button
              onClick={() => setSezioneAttiva('multiple')}
              className={`py-3 px-4 rounded-lg font-semibold transition ${
                sezioneAttiva === 'multiple' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              üé∞ Multiple ({statistiche.multiple.pending})
            </button>
            <button
              onClick={() => setSezioneAttiva('crea-multipla')}
              className={`py-3 px-4 rounded-lg font-semibold transition ${
                sezioneAttiva === 'crea-multipla' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              ‚ûï Crea Multipla
            </button>
            <button
              onClick={() => setSezioneAttiva('budget')}
              className={`py-3 px-4 rounded-lg font-semibold transition ${
                sezioneAttiva === 'budget' ? 'bg-yellow-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              üí∞ Budget
            </button>
          </div>
        </div>

        {/* ========== SEZIONE SINGOLE ========== */}
        {sezioneAttiva === 'singole' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Sidebar */}
            <div className="lg:col-span-1 space-y-6">
              {/* Statistiche Singole */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">üìä Statistiche Singole</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-blue-50 p-3 rounded-lg text-center">
                    <div className="text-2xl font-bold text-blue-600">{statistiche.singole.totali}</div>
                    <div className="text-xs text-gray-600">Totali</div>
                  </div>
                  <div className="bg-green-50 p-3 rounded-lg text-center">
                    <div className="text-2xl font-bold text-green-600">{statistiche.singole.vinte}</div>
                    <div className="text-xs text-gray-600">Vinte</div>
                  </div>
                  <div className="bg-red-50 p-3 rounded-lg text-center">
                    <div className="text-2xl font-bold text-red-600">{statistiche.singole.perse}</div>
                    <div className="text-xs text-gray-600">Perse</div>
                  </div>
                  <div className="bg-yellow-50 p-3 rounded-lg text-center">
                    <div className="text-2xl font-bold text-yellow-600">{statistiche.singole.pending}</div>
                    <div className="text-xs text-gray-600">Pending</div>
                  </div>
                </div>
                <div className="mt-4 pt-4 border-t">
                  <div className="flex justify-between text-sm mb-2">
                    <span className="text-gray-600">Speso:</span>
                    <span className="font-bold text-red-600">‚Ç¨{statistiche.singole.speso.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">Incassato:</span>
                    <span className="font-bold text-green-600">‚Ç¨{statistiche.singole.incassato.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between text-sm mt-2 pt-2 border-t font-bold">
                    <span>Bilancio:</span>
                    <span className={statistiche.singole.incassato - statistiche.singole.speso >= 0 ? 'text-green-600' : 'text-red-600'}>
                      ‚Ç¨{(statistiche.singole.incassato - statistiche.singole.speso).toFixed(2)}
                    </span>
                  </div>
                </div>
              </div>

              {/* Filtri */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">üîç Filtri</h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Campionato</label>
                    <select
                      value={campionatoSelezionato}
                      onChange={(e) => setCampionatoSelezionato(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      {CAMPIONATI.map(c => (
                        <option key={c.id} value={c.id}>{c.nome}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Vista</label>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setVistaCorrente('giorno')}
                        className={`flex-1 py-2 rounded-lg text-sm font-medium ${
                          vistaCorrente === 'giorno' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'
                        }`}
                      >
                        Per Giorno
                      </button>
                      <button
                        onClick={() => setVistaCorrente('tutti')}
                        className={`flex-1 py-2 rounded-lg text-sm font-medium ${
                          vistaCorrente === 'tutti' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'
                        }`}
                      >
                        Tutti
                      </button>
                    </div>
                  </div>
                  {vistaCorrente === 'giorno' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Data</label>
                      <div className="flex items-center gap-2 mb-2">
                        <button onClick={() => cambiaGiorno(-1)} className="p-2 bg-gray-100 rounded-lg hover:bg-gray-200">‚Üê</button>
                        <span className="flex-1 text-center font-medium">{formattaData(dataSelezionata)}</span>
                        <button onClick={() => cambiaGiorno(1)} className="p-2 bg-gray-100 rounded-lg hover:bg-gray-200">‚Üí</button>
                      </div>
                      <input
                        type="date"
                        value={dataSelezionata}
                        onChange={(e) => setDataSelezionata(e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  )}
                </div>
              </div>

              {/* Import (solo Admin) */}
              {isAdmin && (
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-4">üì• Importa Partite</h3>
                  <div className="space-y-3">
                    <button
                      onClick={scaricaTemplate}
                      className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700"
                    >
                      üìÑ Scarica Template
                    </button>
                    <input
                      type="file"
                      accept=".tsv,.txt,.csv"
                      onChange={(e) => e.target.files[0] && importaExcel(e.target.files[0])}
                      className="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700"
                    />
                  </div>
                </div>
              )}
            </div>

            {/* Contenuto Principale - Partite e Pronostici */}
            <div className="lg:col-span-2 space-y-6">
              {/* Partite Disponibili */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-4">‚öΩ Partite Disponibili</h2>
                {partiteDisponibili.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    <div className="text-4xl mb-3">‚öΩ</div>
                    <p>Nessuna partita disponibile</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {partiteDisponibili.map((partita) => (
                      <div key={partita.id} className="border border-gray-200 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              {getStemmaSquadra(partita.squadra_casa) && (
                                <img src={getStemmaSquadra(partita.squadra_casa)} alt="" className="w-6 h-6" />
                              )}
                              <span className="font-bold">{partita.squadra_casa}</span>
                              <span className="text-gray-500">vs</span>
                              <span className="font-bold">{partita.squadra_trasferta}</span>
                              {getStemmaSquadra(partita.squadra_trasferta) && (
                                <img src={getStemmaSquadra(partita.squadra_trasferta)} alt="" className="w-6 h-6" />
                              )}
                            </div>
                            <div className="text-sm text-gray-600">
                              {formattaData(partita.data_partita)} {partita.orario && `- ${partita.orario.slice(0, 5)}`}
                            </div>
                          </div>
                        </div>

                        {isAdmin && (
                          <div className="grid grid-cols-5 gap-2">
                            {partita.quota_1 && (
                              <button
                                onClick={() => {
                                  const importo = prompt('Importo puntata (‚Ç¨):');
                                  if (importo) aggiungiPronosticoSingolo(partita.id, '1', importo);
                                }}
                                className="py-2 bg-green-500 text-white rounded text-xs font-semibold hover:bg-green-600"
                              >
                                1<br/>{partita.quota_1}
                              </button>
                            )}
                            {partita.quota_x && (
                              <button
                                onClick={() => {
                                  const importo = prompt('Importo puntata (‚Ç¨):');
                                  if (importo) aggiungiPronosticoSingolo(partita.id, 'X', importo);
                                }}
                                className="py-2 bg-gray-500 text-white rounded text-xs font-semibold hover:bg-gray-600"
                              >
                                X<br/>{partita.quota_x}
                              </button>
                            )}
                            {partita.quota_2 && (
                              <button
                                onClick={() => {
                                  const importo = prompt('Importo puntata (‚Ç¨):');
                                  if (importo) aggiungiPronosticoSingolo(partita.id, '2', importo);
                                }}
                                className="py-2 bg-red-500 text-white rounded text-xs font-semibold hover:bg-red-600"
                              >
                                2<br/>{partita.quota_2}
                              </button>
                            )}
                            {partita.quota_gol && (
                              <button
                                onClick={() => {
                                  const importo = prompt('Importo puntata (‚Ç¨):');
                                  if (importo) aggiungiPronosticoSingolo(partita.id, 'GOL', importo);
                                }}
                                className="py-2 bg-blue-500 text-white rounded text-xs font-semibold hover:bg-blue-600"
                              >
                                GOL<br/>{partita.quota_gol}
                              </button>
                            )}
                            {partita.quota_over_25 && (
                              <button
                                onClick={() => {
                                  const importo = prompt('Importo puntata (‚Ç¨):');
                                  if (importo) aggiungiPronosticoSingolo(partita.id, 'OVER25', importo);
                                }}
                                className="py-2 bg-orange-500 text-white rounded text-xs font-semibold hover:bg-orange-600"
                              >
                                O2.5<br/>{partita.quota_over_25}
                              </button>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* I Miei Pronostici Singoli */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-4">üéØ I Miei Pronostici Singoli</h2>
                {pronostici.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    <div className="text-4xl mb-3">üìã</div>
                    <p>Nessun pronostico</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {pronostici.map((p) => (
                      <div key={p.id} className="border border-gray-200 rounded-lg p-4">
                        <div className="flex justify-between items-start mb-2">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                p.stato === 'win' ? 'bg-green-100 text-green-800' :
                                p.stato === 'loss' ? 'bg-red-100 text-red-800' :
                                'bg-yellow-100 text-yellow-800'
                              }`}>
                                {p.stato === 'win' ? '‚úì Vinto' : p.stato === 'loss' ? '‚úó Perso' : '‚è≥ Pending'}
                              </span>
                              <span className="text-xs text-gray-600">{formattaData(p.data_partita)}</span>
                            </div>
                            <h3 className="font-bold text-gray-800">{p.partita}</h3>
                            <div className="text-sm text-gray-600 mt-1">
                              <span className="font-medium">Pronostico:</span> {p.pronostico} | 
                              <span className="font-medium"> Quota:</span> {p.quota} |
                              <span className="font-medium"> Puntata:</span> ‚Ç¨{p.importo_puntata?.toFixed(2) || '0.00'}
                            </div>
                            {p.stato === 'win' && (
                              <div className="text-sm font-bold text-green-600 mt-1">
                                Vincita: ‚Ç¨{(p.quota * p.importo_puntata).toFixed(2)} (+‚Ç¨{p.guadagno_netto?.toFixed(2)})
                              </div>
                            )}
                          </div>
                        </div>

                        {isAdmin && p.stato === 'pending' && (
                          <div className="flex gap-2 mt-3">
                            <button
                              onClick={() => aggiornaStatoSingolo(p.id, 'win')}
                              className="px-4 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm"
                            >
                              Vinto
                            </button>
                            <button
                              onClick={() => aggiornaStatoSingolo(p.id, 'loss')}
                              className="px-4 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                            >
                              Perso
                            </button>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* ========== SEZIONE MULTIPLE ========== */}
        {sezioneAttiva === 'multiple' && (
          <div className="space-y-6">
            {/* Statistiche Multiple */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h3 className="text-lg font-semibold text-gray-800 mb-4">üìä Statistiche Multiple</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-purple-50 p-4 rounded-lg text-center">
                  <div className="text-3xl font-bold text-purple-600">{statistiche.multiple.totali}</div>
                  <div className="text-sm text-gray-600">Totali</div>
                </div>
                <div className="bg-green-50 p-4 rounded-lg text-center">
                  <div className="text-3xl font-bold text-green-600">{statistiche.multiple.vinte}</div>
                  <div className="text-sm text-gray-600">Vinte</div>
                </div>
                <div className="bg-red-50 p-4 rounded-lg text-center">
                  <div className="text-3xl font-bold text-red-600">{statistiche.multiple.perse}</div>
                  <div className="text-sm text-gray-600">Perse</div>
                </div>
                <div className="bg-yellow-50 p-4 rounded-lg text-center">
                  <div className="text-3xl font-bold text-yellow-600">{statistiche.multiple.pending}</div>
                  <div className="text-sm text-gray-600">Pending</div>
                </div>
              </div>
              <div className="mt-6 pt-4 border-t grid grid-cols-3 gap-4">
                <div className="text-center">
                  <div className="text-sm text-gray-600">Speso</div>
                  <div className="text-2xl font-bold text-red-600">‚Ç¨{statistiche.multiple.speso.toFixed(2)}</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-gray-600">Incassato</div>
                  <div className="text-2xl font-bold text-green-600">‚Ç¨{statistiche.multiple.incassato.toFixed(2)}</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-gray-600">Bilancio</div>
                  <div className={`text-2xl font-bold ${statistiche.multiple.incassato - statistiche.multiple.speso >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    ‚Ç¨{(statistiche.multiple.incassato - statistiche.multiple.speso).toFixed(2)}
                  </div>
                </div>
              </div>
            </div>

            {/* Lista Multiple */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">üé∞ Le Mie Multiple</h2>
              {multiple.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <div className="text-4xl mb-3">üé∞</div>
                  <p>Nessuna multipla creata</p>
                  <button
                    onClick={() => setSezioneAttiva('crea-multipla')}
                    className="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
                  >
                    ‚ûï Crea la tua prima multipla
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  {multiple.map((m) => (
                    <div key={m.id} className="border-2 border-gray-200 rounded-lg p-4">
                      <div className="flex justify-between items-start mb-3">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <h3 className="text-xl font-bold text-gray-800">{m.nome}</h3>
                            <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                              m.stato === 'win' ? 'bg-green-100 text-green-800' :
                              m.stato === 'loss' ? 'bg-red-100 text-red-800' :
                              'bg-yellow-100 text-yellow-800'
                            }`}>
                              {m.stato === 'win' ? '‚úì VINTA' : m.stato === 'loss' ? '‚úó PERSA' : '‚è≥ IN CORSO'}
                            </span>
                          </div>
                          <div className="grid grid-cols-3 gap-4 text-sm">
                            <div>
                              <span className="text-gray-600">Quota Totale:</span>
                              <div className="text-lg font-bold text-purple-600">{m.quota_totale}</div>
                            </div>
                            <div>
                              <span className="text-gray-600">Puntata:</span>
                              <div className="text-lg font-bold text-blue-600">‚Ç¨{m.importo_puntata?.toFixed(2)}</div>
                            </div>
                            <div>
                              <span className="text-gray-600">Vincita Potenziale:</span>
                              <div className="text-lg font-bold text-green-600">‚Ç¨{m.guadagno_potenziale?.toFixed(2)}</div>
                            </div>
                          </div>
                        </div>
                        {isAdmin && (
                          <button
                            onClick={() => eliminaMultipla(m.id)}
                            className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                          >
                            üóëÔ∏è
                          </button>
                        )}
                      </div>

                      {/* Pronostici della multipla */}
                      <div className="border-t pt-3 mt-3">
                        <h4 className="font-semibold text-gray-700 mb-2">Pronostici ({m.pronostici?.length || 0}):</h4>
                        <div className="space-y-2">
                          {m.pronostici?.map((p, idx) => (
                            <div key={idx} className="bg-gray-50 p-3 rounded-lg">
                              <div className="flex justify-between items-center">
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-800">{p.partita_nome}</div>
                                  <div className="text-sm text-gray-600">
                                    {formattaData(p.data_partita)} | {p.campionato}
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="font-bold text-purple-600">{p.pronostico}</div>
                                  <div className="text-sm text-gray-600">Quota: {p.quota}</div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Azioni Admin */}
                      {isAdmin && m.stato === 'pending' && (
                        <div className="flex gap-2 mt-4 pt-4 border-t">
                          <button
                            onClick={() => aggiornaStatoMultipla(m.id, 'win')}
                            className="flex-1 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold"
                          >
                            ‚úì VINTA
                          </button>
                          <button
                            onClick={() => aggiornaStatoMultipla(m.id, 'loss')}
                            className="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold"
                          >
                            ‚úó PERSA
                          </button>
                        </div>
                      )}

                      {m.stato === 'win' && (
                        <div className="mt-4 pt-4 border-t bg-green-50 p-3 rounded-lg">
                          <div className="text-center">
                            <div className="text-sm text-gray-600">Hai vinto</div>
                            <div className="text-3xl font-bold text-green-600">‚Ç¨{m.guadagno_potenziale?.toFixed(2)}</div>
                            <div className="text-sm text-green-700">+‚Ç¨{m.guadagno_netto?.toFixed(2)} di guadagno netto</div>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* ========== SEZIONE CREA MULTIPLA ========== */}
        {sezioneAttiva === 'crea-multipla' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Sidebar - Riepilogo Multipla */}
            <div className="lg:col-span-1">
              <div className="bg-white rounded-lg shadow-lg p-6 sticky top-4">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">üìã Riepilogo Multipla</h3>
                
                <div className="space-y-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Nome Multipla</label>
                    <input
                      type="text"
                      value={nuovaMultipla.nome}
                      onChange={(e) => setNuovaMultipla({...nuovaMultipla, nome: e.target.value})}
                      placeholder="es. Multipla Weekend"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Importo Puntata (‚Ç¨)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={nuovaMultipla.importo}
                      onChange={(e) => setNuovaMultipla({...nuovaMultipla, importo: e.target.value})}
                      placeholder="10.00"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    />
                    <div className="text-xs text-gray-500 mt-1">
                      Saldo disponibile: ‚Ç¨{budget?.saldo_attuale?.toFixed(2) || '0.00'}
                    </div>
                  </div>
                </div>

                {/* Pronostici Selezionati */}
                <div className="border-t pt-4">
                  <h4 className="font-semibold text-gray-700 mb-2">
                    Pronostici Selezionati ({nuovaMultipla.pronostici.length})
                  </h4>
                  {nuovaMultipla.pronostici.length === 0 ? (
                    <p className="text-sm text-gray-500 text-center py-4">
                      Nessun pronostico selezionato
                    </p>
                  ) : (
                    <div className="space-y-2 mb-4">
                      {nuovaMultipla.pronostici.map((p, idx) => (
                        <div key={idx} className="bg-purple-50 p-3 rounded-lg relative">
                          <button
                            onClick={() => rimuoviPronosticoDaMultipla(idx)}
                            className="absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold"
                          >
                            ‚úï
                          </button>
                          <div className="pr-6">
                            <div className="text-sm font-semibold text-gray-800">{p.partita_nome}</div>
                            <div className="text-xs text-gray-600">{formattaData(p.data_partita)}</div>
                            <div className="flex justify-between items-center mt-1">
                              <span className="text-xs font-medium text-purple-600">{p.pronostico}</span>
                              <span className="text-sm font-bold text-purple-700">{p.quota}</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Calcoli */}
                {nuovaMultipla.pronostici.length > 0 && (
                  <div className="border-t pt-4 space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="font-medium text-gray-700">Quota Totale:</span>
                      <span className="text-xl font-bold text-purple-600">{calcolaQuotaTotale()}</span>
                    </div>
                    {nuovaMultipla.importo && (
                      <>
                        <div className="flex justify-between items-center">
                          <span className="font-medium text-gray-700">Vincita Potenziale:</span>
                          <span className="text-xl font-bold text-green-600">‚Ç¨{calcolaGuadagnoPotenziale()}</span>
                        </div>
                        <div className="flex justify-between items-center text-sm">
                          <span className="text-gray-600">Guadagno Netto:</span>
                          <span className="font-bold text-green-600">
                            +‚Ç¨{(parseFloat(calcolaGuadagnoPotenziale()) - parseFloat(nuovaMultipla.importo || 0)).toFixed(2)}
                          </span>
                        </div>
                      </>
                    )}
                  </div>
                )}

                {/* Pulsante Salva */}
                <button
                  onClick={salvaMultipla}
                  disabled={nuovaMultipla.pronostici.length < 2 || !nuovaMultipla.nome || !nuovaMultipla.importo}
                  className="w-full mt-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  üíæ Salva Multipla
                </button>
              </div>
            </div>

            {/* Contenuto Principale - Selezione Partite */}
            <div className="lg:col-span-2">
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-4">‚öΩ Seleziona Partite</h2>

                {/* Filtri */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Campionato</label>
                    <select
                      value={filtriMultipla.campionato}
                      onChange={(e) => setFiltriMultipla({...filtriMultipla, campionato: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    >
                      <option value="tutti">Tutti i campionati</option>
                      {CAMPIONATI.map(c => (
                        <option key={c.id} value={c.id}>{c.nome}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Data Inizio</label>
                    <input
                      type="date"
                      value={filtriMultipla.dataInizio}
                      onChange={(e) => setFiltriMultipla({...filtriMultipla, dataInizio: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Data Fine</label>
                    <input
                      type="date"
                      value={filtriMultipla.dataFine}
                      onChange={(e) => setFiltriMultipla({...filtriMultipla, dataFine: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                </div>

                {/* Partite */}
                <div className="space-y-4">
                  {partiteFiltrate.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <div className="text-4xl mb-3">‚öΩ</div>
                      <p>Nessuna partita trovata con questi filtri</p>
                    </div>
                  ) : (
                    partiteFiltrate.map((partita) => (
                      <div key={partita.id} className="border border-gray-200 rounded-lg p-4 hover:border-purple-400 transition">
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              {getStemmaSquadra(partita.squadra_casa) && (
                                <img src={getStemmaSquadra(partita.squadra_casa)} alt="" className="w-6 h-6" />
                              )}
                              <span className="font-bold">{partita.squadra_casa}</span>
                              <span className="text-gray-500">vs</span>
                              <span className="font-bold">{partita.squadra_trasferta}</span>
                              {getStemmaSquadra(partita.squadra_trasferta) && (
                                <img src={getStemmaSquadra(partita.squadra_trasferta)} alt="" className="w-6 h-6" />
                              )}
                            </div>
                            <div className="text-sm text-gray-600">
                              {formattaData(partita.data_partita)} {partita.orario && `- ${partita.orario.slice(0, 5)}`} | {partita.campionato}
                            </div>
                          </div>
                        </div>

                        {/* Quote Selezionabili */}
                        <div className="grid grid-cols-5 gap-2">
                          {partita.quota_1 && (
                            <button
                              onClick={() => aggiungiPronosticoAMultipla(partita, '1')}
                              className="py-2 bg-green-100 text-green-800 rounded text-xs font-semibold hover:bg-green-200 border border-green-300"
                            >
                              1<br/>{partita.quota_1}
                            </button>
                          )}
                          {partita.quota_x && (
                            <button
                              onClick={() => aggiungiPronosticoAMultipla(partita, 'X')}
                              className="py-2 bg-gray-100 text-gray-800 rounded text-xs font-semibold hover:bg-gray-200 border border-gray-300"
                            >
                              X<br/>{partita.quota_x}
                            </button>
                          )}
                          {partita.quota_2 && (
                            <button
                              onClick={() => aggiungiPronosticoAMultipla(partita, '2')}
                              className="py-2 bg-red-100 text-red-800 rounded text-xs font-semibold hover:bg-red-200 border border-red-300"
                            >
                              2<br/>{partita.quota_2}
                            </button>
                          )}
                          {partita.quota_gol && (
                            <button
                              onClick={() => aggiungiPronosticoAMultipla(partita, 'GOL')}
                              className="py-2 bg-blue-100 text-blue-800 rounded text-xs font-semibold hover:bg-blue-200 border border-blue-300"
                            >
                              GOL<br/>{partita.quota_gol}
                            </button>
                          )}
                          {partita.quota_over_25 && (
                            <button
                              onClick={() => aggiungiPronosticoAMultipla(partita, 'OVER25')}
                              className="py-2 bg-orange-100 text-orange-800 rounded text-xs font-semibold hover:bg-orange-200 border border-orange-300"
                            >
                              O2.5<br/>{partita.quota_over_25}
                            </button>
                          )}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ========== SEZIONE BUDGET ========== */}
        {sezioneAttiva === 'budget' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Sidebar - Saldo e Azioni */}
            <div className="lg:col-span-1 space-y-6">
              {/* Saldo Attuale */}
              <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow-lg p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-2">üí∞ Saldo Attuale</h3>
                <div className="text-4xl font-bold text-yellow-700 mb-4">
                  ‚Ç¨{budget?.saldo_attuale?.toFixed(2) || '0.00'}
                </div>
                <div className="text-sm text-gray-600">
                  Saldo iniziale: ‚Ç¨{budget?.saldo_iniziale?.toFixed(2) || '0.00'}
                </div>
              </div>

              {/* Azioni Budget */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">‚ûï Gestisci Saldo</h3>
                <div className="space-y-3">
                  <button
                    onClick={() => {
                      const importo = prompt('Importo deposito (‚Ç¨):');
                      if (importo && parseFloat(importo) > 0) {
                        aggiungiMovimento('deposito', parseFloat(importo), 'Deposito');
                      }
                    }}
                    className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
                  >
                    üíµ Deposita
                  </button>
                  <button
                    onClick={() => {
                      const importo = prompt('Importo prelievo (‚Ç¨):');
                      if (importo && parseFloat(importo) > 0 && parseFloat(importo) <= budget.saldo_attuale) {
                        aggiungiMovimento('prelievo', parseFloat(importo), 'Prelievo');
                      } else if (importo) {
                        alert('Importo non valido o saldo insufficiente!');
                      }
                    }}
                    className="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold"
                  >
                    üí∏ Preleva
                  </button>
                </div>
              </div>

              {/* Riepilogo Totale */}
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">üìä Riepilogo Totale</h3>
                <div className="space-y-3">
                  <div className="flex justify-between items-center pb-2 border-b">
                    <span className="text-gray-600">Singole Spese:</span>
                    <span className="font-bold text-red-600">‚Ç¨{statistiche.singole.speso.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center pb-2 border-b">
                    <span className="text-gray-600">Singole Incassate:</span>
                    <span className="font-bold text-green-600">‚Ç¨{statistiche.singole.incassato.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center pb-2 border-b">
                    <span className="text-gray-600">Multiple Spese:</span>
                    <span className="font-bold text-red-600">‚Ç¨{statistiche.multiple.speso.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center pb-2 border-b">
                    <span className="text-gray-600">Multiple Incassate:</span>
                    <span className="font-bold text-green-600">‚Ç¨{statistiche.multiple.incassato.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center pt-2 text-lg">
                    <span className="font-bold">Bilancio Totale:</span>
                    <span className={`font-bold ${
                      (statistiche.singole.incassato + statistiche.multiple.incassato) - 
                      (statistiche.singole.speso + statistiche.multiple.speso) >= 0 
                      ? 'text-green-600' : 'text-red-600'
                    }`}>
                      ‚Ç¨{((statistiche.singole.incassato + statistiche.multiple.incassato) - 
                         (statistiche.singole.speso + statistiche.multiple.speso)).toFixed(2)}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            {/* Storico Movimenti */}
            <div className="lg:col-span-2">
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-4">üìú Storico Movimenti</h2>
                {movimenti.length === 0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <div className="text-4xl mb-3">üìú</div>
                    <p>Nessun movimento registrato</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {movimenti.map((m) => (
                      <div key={m.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <span className={`text-2xl ${
                              m.tipo === 'deposito' ? 'üíµ' :
                              m.tipo === 'prelievo' ? 'üí∏' :
                              m.tipo === 'vincita' ? 'üéâ' :
                              m.tipo === 'puntata' ? 'üé≤' : '‚Ü©Ô∏è'
                            }`}>
                              {m.tipo === 'deposito' ? 'üíµ' :
                               m.tipo === 'prelievo' ? 'üí∏' :
                               m.tipo === 'vincita' ? 'üéâ' :
                               m.tipo === 'puntata' ? 'üé≤' : '‚Ü©Ô∏è'}
                            </span>
                            <div>
                              <div className="font-semibold text-gray-800 capitalize">{m.tipo}</div>
                              <div className="text-sm text-gray-600">{m.descrizione}</div>
                              <div className="text-xs text-gray-500">
                                {new Date(m.created_at).toLocaleString('it-IT')}
                              </div>
                            </div>
                          </div>
                        </div>
                        <div className={`text-xl font-bold ${
                          m.tipo === 'deposito' || m.tipo === 'vincita' || m.tipo === 'rimborso' 
                          ? 'text-green-600' : 'text-red-600'
                        }`}>
                          {m.tipo === 'deposito' || m.tipo === 'vincita' || m.tipo === 'rimborso' ? '+' : '-'}
                          ‚Ç¨{m.importo?.toFixed(2)}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>