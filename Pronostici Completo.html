<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pronostici - Sistema Completo</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

const SUPABASE_URL = 'https://jhquweahxrixlxdolpwc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpocXV3ZWFoeHJpeGx4ZG9scHdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDYxMTksImV4cCI6MjA4MDAyMjExOX0.UGA3_cqQvzXC79gKsceFnmqrCnOy1cjJQ7uEKLE0K3c';
const ADMIN_USER_ID = '1b2932fe-9d8e-4518-a8cf-79ae5cf98bcd';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const STEMMI_SQUADRE = {
  'AC Milan': 'https://media.api-sports.io/football/teams/489.png',
  'Milan': 'https://media.api-sports.io/football/teams/489.png',
  'Inter': 'https://media.api-sports.io/football/teams/505.png',
  'Juventus': 'https://media.api-sports.io/football/teams/497.png',
  'Napoli': 'https://media.api-sports.io/football/teams/492.png'
};

function getStemmaSquadra(nome) {
  return STEMMI_SQUADRE[nome?.trim()] || null;
}

const CAMPIONATI = [
  { id: 'serie-a', nome: 'Serie A' },
  { id: 'premier-league', nome: 'Premier League' },
  { id: 'la-liga', nome: 'La Liga' }
];

function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [tipoVista, setTipoVista] = useState('singole');
  const [loginData, setLoginData] = useState({ email: '', password: '' });
  const [mostraRegistrazione, setMostraRegistrazione] = useState(false);
  
  const [pronostici, setPronostici] = useState([]);
  const [partiteDisponibili, setPartiteDisponibili] = useState([]);
  const [tutteLePartite, setTutteLePartite] = useState([]);
  const [puntataPronostico, setPuntataPronostico] = useState('');
  
  const [multiple, setMultiple] = useState([]);
  const [nuovaMultipla, setNuovaMultipla] = useState({ nome: '', puntata: '', partite_selezionate: [] });
  const [filtroCampionato, setFiltroCampionato] = useState('tutti');
  const [filtroData, setFiltroData] = useState('tutti');
  
  const [budget, setBudget] = useState({ saldo: 0, movimenti: [], id: null });
  const [nuovoMovimento, setNuovoMovimento] = useState({ tipo: 'deposito', importo: '', descrizione: '' });

  useEffect(() => {
    checkUser();
    const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
      setUser(session?.user || null);
    });
    return () => authListener?.subscription?.unsubscribe();
  }, []);

  useEffect(() => {
    if (user) {
      caricaTutto();
    }
  }, [user]);

  async function checkUser() {
    const { data: { session } } = await supabase.auth.getSession();
    setUser(session?.user || null);
    setLoading(false);
  }

  const isAdmin = user?.id === ADMIN_USER_ID;

  async function caricaTutto() {
    await Promise.all([
      caricaPronostici(),
      caricaPartite(),
      caricaMultiple(),
      caricaBudget()
    ]);
  }

  async function login(e) {
    e.preventDefault();
    try {
      const { error } = await supabase.auth.signInWithPassword(loginData);
      if (error) throw error;
    } catch (error) {
      alert('Errore: ' + error.message);
    }
  }

  async function registrazione(e) {
    e.preventDefault();
    try {
      const { error } = await supabase.auth.signUp(loginData);
      if (error) throw error;
      alert('‚úÖ Registrazione completata!');
      setMostraRegistrazione(false);
    } catch (error) {
      alert('Errore: ' + error.message);
    }
  }

  async function logout() {
    await supabase.auth.signOut();
  }

  async function caricaPronostici() {
    try {
      const { data } = await supabase.from('pronostici').select('*').eq('user_id', user?.id).order('created_at', { ascending: false });
      setPronostici(data || []);
    } catch (error) {
      console.error(error);
    }
  }

  async function caricaPartite() {
    try {
      const { data } = await supabase.from('partite').select('*').order('data_partita', { ascending: true });
      setPartiteDisponibili(data || []);
      setTutteLePartite(data || []);
    } catch (error) {
      console.error(error);
    }
  }

  async function caricaMultiple() {
    try {
      const { data } = await supabase.from('multiple').select(`
        *,
        multiple_partite (
          id,
          pronostico,
          quota,
          partite (
            id,
            squadra_casa,
            squadra_trasferta,
            data_partita
          )
        )
      `).eq('user_id', user?.id).order('created_at', { ascending: false });
      setMultiple(data || []);
    } catch (error) {
      console.error(error);
    }
  }

  async function caricaBudget() {
    try {
      let { data: budgetData } = await supabase.from('budget').select('*').eq('user_id', user?.id).maybeSingle();
      
      if (!budgetData && user) {
        const { data: newBudget } = await supabase.from('budget').insert([{ user_id: user.id, saldo: 0 }]).select().single();
        budgetData = newBudget;
      }

      if (budgetData) {
        const { data: movimenti } = await supabase.from('movimenti_budget').select('*').eq('budget_id', budgetData.id).order('created_at', { ascending: false });
        setBudget({ saldo: budgetData.saldo || 0, movimenti: movimenti || [], id: budgetData.id });
      }
    } catch (error) {
      console.error(error);
    }
  }

  async function aggiungiPronosticoSingolo(partitaId, tipo) {
    const puntata = parseFloat(puntataPronostico);
    if (!puntata || puntata <= 0) {
      alert('‚ö†Ô∏è Inserisci puntata valida!');
      return;
    }

    if (puntata > budget.saldo) {
      alert('‚ö†Ô∏è Saldo insufficiente!');
      return;
    }

    const partita = partiteDisponibili.find(p => p.id === partitaId);
    if (!partita) return;

    let quota = 0, label = '';
    switch(tipo) {
      case '1': quota = partita.quota_1; label = '1'; break;
      case 'X': quota = partita.quota_x; label = 'X'; break;
      case '2': quota = partita.quota_2; label = '2'; break;
      case 'GOL': quota = partita.quota_gol; label = 'Gol'; break;
      case 'OVER25': quota = partita.quota_over_25; label = 'Over 2.5'; break;
    }

    if (!quota) {
      alert('‚ö†Ô∏è Quota non disponibile');
      return;
    }

    try {
      await supabase.from('pronostici').insert([{
        partita: `${partita.squadra_casa} vs ${partita.squadra_trasferta}`,
        pronostico: label,
        quota,
        puntata,
        stato: 'pending',
        campionato: partita.campionato,
        data_partita: partita.data_partita,
        user_id: user.id
      }]);

      await supabase.from('budget').update({ saldo: budget.saldo - puntata }).eq('id', budget.id);
      
      await supabase.from('movimenti_budget').insert([{
        budget_id: budget.id,
        tipo: 'puntata',
        importo: puntata,
        descrizione: `Singola: ${partita.squadra_casa} vs ${partita.squadra_trasferta}`,
        user_id: user.id
      }]);

      setPuntataPronostico('');
      await caricaTutto();
      alert('‚úÖ Pronostico aggiunto!');
    } catch (error) {
      alert('‚ùå Errore: ' + error.message);
    }
  }

  async function aggiornaStatoPronostico(id, stato) {
    try {
      const p = pronostici.find(x => x.id === id);
      await supabase.from('pronostici').update({ stato }).eq('id', id);

      if (stato === 'win') {
        const vincita = p.puntata * p.quota;
        await supabase.from('budget').update({ saldo: budget.saldo + vincita }).eq('id', budget.id);
        await supabase.from('movimenti_budget').insert([{
          budget_id: budget.id,
          tipo: 'vincita',
          importo: vincita,
          descrizione: `Vincita: ${p.partita}`,
          user_id: user.id
        }]);
        alert(`üéâ Vincita: ‚Ç¨${vincita.toFixed(2)}`);
      }

      await caricaTutto();
    } catch (error) {
      alert('‚ùå Errore: ' + error.message);
    }
  }

  function aggiungiPartitaMultipla(partita, pronostico, quota) {
    const esiste = nuovaMultipla.partite_selezionate.find(p => p.partita_id === partita.id && p.pronostico === pronostico);
    if (esiste) {
      alert('‚ö†Ô∏è Gi√† aggiunta!');
      return;
    }

    setNuovaMultipla(prev => ({
      ...prev,
      partite_selezionate: [...prev.partite_selezionate, {
        partita_id: partita.id,
        nome_partita: `${partita.squadra_casa} vs ${partita.squadra_trasferta}`,
        pronostico,
        quota,
        data: partita.data_partita
      }]
    }));
    alert('‚úÖ Aggiunta alla multipla!');
  }

  function rimuoviPartitaMultipla(index) {
    setNuovaMultipla(prev => ({
      ...prev,
      partite_selezionate: prev.partite_selezionate.filter((_, i) => i !== index)
    }));
  }

  async function creaMultipla(e) {
    e.preventDefault();
    const { nome, puntata, partite_selezionate } = nuovaMultipla;
    
    if (!nome || !puntata || partite_selezionate.length === 0) {
      alert('‚ö†Ô∏è Compila tutti i campi!');
      return;
    }

    const puntataNum = parseFloat(puntata);
    if (puntataNum > budget.saldo) {
      alert('‚ö†Ô∏è Saldo insufficiente!');
      return;
    }

    try {
      const quotaTotale = partite_selezionate.reduce((acc, p) => acc * p.quota, 1);

      const { data: multipla } = await supabase.from('multiple').insert([{
        nome,
        puntata: puntataNum,
        quota_totale: quotaTotale,
        guadagno_potenziale: (quotaTotale * puntataNum) - puntataNum,
        stato: 'pending',
        user_id: user.id
      }]).select().single();

      await supabase.from('multiple_partite').insert(partite_selezionate.map(p => ({
        multipla_id: multipla.id,
        partita_id: p.partita_id,
        pronostico: p.pronostico,
        quota: p.quota
      })));

      await supabase.from('budget').update({ saldo: budget.saldo - puntataNum }).eq('id', budget.id);
      
      await supabase.from('movimenti_budget').insert([{
        budget_id: budget.id,
        tipo: 'puntata',
        importo: puntataNum,
        descrizione: `Multipla: ${nome}`,
        user_id: user.id
      }]);

      setNuovaMultipla({ nome: '', puntata: '', partite_selezionate: [] });
      await caricaTutto();
      alert('‚úÖ Multipla creata!');
    } catch (error) {
      alert('‚ùå Errore: ' + error.message);
    }
  }

  async function aggiornaStatoMultipla(id, stato) {
    try {
      const m = multiple.find(x => x.id === id);
      await supabase.from('multiple').update({ stato }).eq('id', id);

      if (stato === 'win') {
        const vincita = m.puntata * m.quota_totale;
        await supabase.from('budget').update({ saldo: budget.saldo + vincita }).eq('id', budget.id);
        await supabase.from('movimenti_budget').insert([{
          budget_id: budget.id,
          tipo: 'vincita',
          importo: vincita,
          descrizione: `Vincita Multipla: ${m.nome}`,
          user_id: user.id
        }]);
        alert(`üéâ Vincita: ‚Ç¨${vincita.toFixed(2)}`);
      }

      await caricaTutto();
    } catch (error) {
      alert('‚ùå Errore: ' + error.message);
    }
  }

  async function aggiungiMovimento(e) {
    e.preventDefault();
    const { tipo, importo } = nuovoMovimento;
    const amount = parseFloat(importo);

    if (amount <= 0) {
      alert('‚ö†Ô∏è Importo non valido!');
      return;
    }

    const nuovoSaldo = tipo === 'deposito' ? budget.saldo + amount : budget.saldo - amount;
    if (nuovoSaldo < 0) {
      alert('‚ö†Ô∏è Saldo insufficiente!');
      return;
    }

    try {
      await supabase.from('budget').update({ saldo: nuovoSaldo }).eq('id', budget.id);
      await supabase.from('movimenti_budget').insert([{
        budget_id: budget.id,
        tipo,
        importo: amount,
        descrizione: nuovoMovimento.descrizione || tipo,
        user_id: user.id
      }]);

      setNuovoMovimento({ tipo: 'deposito', importo: '', descrizione: '' });
      await caricaBudget();
      alert('‚úÖ Movimento registrato!');
    } catch (error) {
      alert('‚ùå Errore: ' + error.message);
    }
  }

  function scaricaTemplate() {
    const template = `SQUADRA_CASA\tSQUADRA_TRASFERTA\tCAMPIONATO\tDATA\tORARIO\tQUOTA_1\tQUOTA_X\tQUOTA_2\tQUOTA_GOL\tQUOTA_OVER_25
Inter\tMilan\tserie-a\t2024-12-15\t20:45\t2.10\t3.40\t3.50\t1.40\t2.60`;
    const blob = new Blob([template], { type: 'text/tab-separated-values' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'template.tsv';
    a.click();
  }

  async function importaExcel(file) {
    try {
      const text = await file.text();
      const lines = text.split('\n').filter(l => l.trim());
      const partite = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split('\t');
        partite.push({
          squadra_casa: values[0]?.trim(),
          squadra_trasferta: values[1]?.trim(),
          campionato: values[2]?.trim(),
          data_partita: values[3]?.trim(),
          orario: values[4]?.trim(),
          quota_1: parseFloat(values[5]),
          quota_x: parseFloat(values[6]),
          quota_2: parseFloat(values[7]),
          quota_gol: parseFloat(values[8]),
          quota_over_25: parseFloat(values[9]),
          user_id: user.id,
          batch_importazione: new Date().toISOString()
        });
      }

      await supabase.from('partite').insert(partite);
      alert(`‚úÖ ${partite.length} partite importate!`);
      await caricaPartite();
    } catch (error) {
      alert('‚ùå Errore: ' + error.message);
    }
  }

  const partiteFiltrate = tutteLePartite.filter(p => {
    const matchCamp = filtroCampionato === 'tutti' || p.campionato === filtroCampionato;
    const matchData = filtroData === 'tutti' || p.data_partita === filtroData;
    return matchCamp && matchData;
  });

  const dateUniche = [...new Set(tutteLePartite.map(p => p.data_partita))].sort();

  if (loading) {
    return <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
      <div className="text-2xl">Caricamento...</div>
    </div>;
  }

  if (!user) {
    return <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
        <h1 className="text-3xl font-bold mb-6 text-center">‚öΩ Pronostici</h1>
        {!mostraRegistrazione ? (
          <>
            <form onSubmit={login} className="space-y-4">
              <input type="email" value={loginData.email} onChange={(e) => setLoginData({...loginData, email: e.target.value})} placeholder="Email" className="w-full px-4 py-2 border rounded-lg" required />
              <input type="password" value={loginData.password} onChange={(e) => setLoginData({...loginData, password: e.target.value})} placeholder="Password" className="w-full px-4 py-2 border rounded-lg" required />
              <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold">Accedi</button>
            </form>
            <button onClick={() => setMostraRegistrazione(true)} className="w-full mt-3 text-blue-600 text-sm">Registrati</button>
          </>
        ) : (
          <>
            <form onSubmit={registrazione} className="space-y-4">
              <input type="email" value={loginData.email} onChange={(e) => setLoginData({...loginData, email: e.target.value})} placeholder="Email" className="w-full px-4 py-2 border rounded-lg" required />
              <input type="password" value={loginData.password} onChange={(e) => setLoginData({...loginData, password: e.target.value})} placeholder="Password (min 6)" className="w-full px-4 py-2 border rounded-lg" minLength="6" required />
              <button type="submit" className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold">Registrati</button>
            </form>
            <button onClick={() => setMostraRegistrazione(false)} className="w-full mt-3 text-blue-600 text-sm">Accedi</button>
          </>
        )}
      </div>
    </div>;
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold">‚öΩ Sistema Pronostici</h1>
              <p className="text-gray-600">Saldo: <span className="font-bold text-green-600">‚Ç¨{budget.saldo.toFixed(2)}</span></p>
            </div>
            <button onClick={logout} className="px-4 py-2 bg-red-500 text-white rounded-lg">Esci</button>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-lg p-4 mb-6">
          <div className="flex gap-3 flex-wrap">
            <button onClick={() => setTipoVista('singole')} className={`flex-1 min-w-[120px] py-3 rounded-lg font-semibold ${tipoVista === 'singole' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>üéØ Singole</button>
            <button onClick={() => setTipoVista('multiple')} className={`flex-1 min-w-[120px] py-3 rounded-lg font-semibold ${tipoVista === 'multiple' ? 'bg-purple-600 text-white' : 'bg-gray-100'}`}>üé≤ Multiple</button>
            <button onClick={() => setTipoVista('budget')} className={`flex-1 min-w-[120px] py-3 rounded-lg font-semibold ${tipoVista === 'budget' ? 'bg-green-600 text-white' : 'bg-gray-100'}`}>üí∞ Budget</button>
            {isAdmin && <button onClick={() => setTipoVista('admin')} className={`flex-1 min-w-[120px] py-3 rounded-lg font-semibold ${tipoVista === 'admin' ? 'bg-orange-600 text-white' : 'bg-gray-100'}`}>‚öôÔ∏è Admin</button>}
          </div>
        </div>

        {tipoVista === 'singole' && (
          <div className="space-y-6">
            {isAdmin && (
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-xl font-bold mb-4">‚öΩ Aggiungi Pronostico</h3>
                <div className="mb-4">
                  <input
                    type="number"
                    step="0.01"
                    value={puntataPronostico}
                    onChange={(e) => setPuntataPronostico(e.target.value)}
                    placeholder="Puntata (es. 10.00)"
                    className="w-full px-4 py-2 border rounded-lg"
                  />
                </div>
                <div className="space-y-3 max-h-96 overflow-y-auto">
                  {partiteDisponibili.slice(0, 20).map(p => (
                    <div key={p.id} className="border rounded-lg p-3">
                      <div className="font-bold mb-2">{p.squadra_casa} vs {p.squadra_trasferta}</div>
                      <div className="grid grid-cols-5 gap-2">
                        {p.quota_1 && <button onClick={() => aggiungiPronosticoSingolo(p.id, '1')} className="px-2 py-1 bg-green-500 text-white rounded text-sm font-semibold">1<br/>{p.quota_1}</button>}
                        {p.quota_x && <button onClick={() => aggiungiPronosticoSingolo(p.id, 'X')} className="px-2 py-1 bg-gray-500 text-white rounded text-sm font-semibold">X<br/>{p.quota_x}</button>}
                        {p.quota_2 && <button onClick={() => aggiungiPronosticoSingolo(p.id, '2')} className="px-2 py-1 bg-red-500 text-white rounded text-sm font-semibold">2<br/>{p.quota_2}</button>}
                        {p.quota_gol && <button onClick={() => aggiungiPronosticoSingolo(p.id, 'GOL')} className="px-2 py-1 bg-blue-500 text-white rounded text-sm font-semibold">GOL<br/>{p.quota_gol}</button>}
                        {p.quota_over_25 && <button onClick={() => aggiungiPronosticoSingolo(p.id, 'OVER25')} className="px-2 py-1 bg-orange-500 text-white rounded text-sm font-semibold">O2.5<br/>{p.quota_over_25}</button>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h3 className="text-xl font-bold mb-4">üìã I Miei Pronostici ({pronostici.length})</h3>
              {pronostici.length === 0 ? (
                <p className="text-center py-8 text-gray-500">Nessun pronostico</p>
              ) : (
                <div className="space-y-3">
                  {pronostici.map(p => (
                    <div key={p.id} className="border rounded-lg p-4">
                      <div className="flex justify-between mb-2">
                        <span className={`px-3 py-1 rounded-full text-sm ${p.stato === 'win' ? 'bg-green-100 text-green-800' : p.stato === 'loss' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}`}>
                          {p.stato === 'win' ? '‚úì Vinto' : p.stato === 'loss' ? '‚úó Perso' : '‚è≥ Pending'}
                        </span>
                      </div>
                      <h4 className="font-bold mb-2">{p.partita}</h4>
                      <div className="grid grid-cols-2 gap-2 text-sm mb-3">
                        <div>Pronostico: {p.pronostico}</div>
                        <div>Quota: {p.quota}</div>
                        <div>Puntata: ‚Ç¨{p.puntata?.toFixed(2)}</div>
                        <div>Vincita: ‚Ç¨{(p.quota * (p.puntata || 0)).toFixed(2)}</div>
                      </div>
                      {isAdmin && p.stato === 'pending' && (
                        <div className="flex gap-2">
                          <button onClick={() => aggiornaStatoPronostico(p.id, 'win')} className="px-3 py-1 bg-green-500 text-white rounded text-sm">Vinto</button>
                          <button onClick={() => aggiornaStatoPronostico(p.id, 'loss')} className="px-3 py-1 bg-red-500 text-white rounded text-sm">Perso</button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {tipoVista === 'multiple' && (
          <div className="space-y-6">
            {isAdmin && (
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-xl font-bold mb-4">‚ûï Crea Multipla</h3>
                
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <select value={filtroCampionato} onChange={(e) => setFiltroCampionato(e.target.value)} className="px-4 py-2 border rounded-lg">
                    <option value="tutti">Tutti i campionati</option>
                    {CAMPIONATI.map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}
                  </select>
<select value={filtroData} onChange={(e) => setFiltroData(e.target.value)} className="px-4 py-2 border rounded-lg">
                    <option value="tutti">Tutte le date</option>
                    {dateUniche.map(d => <option key={d} value={d}>{d}</option>)}
                  </select>
                </div>

                <div className="max-h-96 overflow-y-auto border rounded-lg p-4 mb-4">
                  <h4 className="font-bold mb-3">‚öΩ Partite ({partiteFiltrate.length})</h4>
                  <div className="space-y-3">
                    {partiteFiltrate.map(p => (
                      <div key={p.id} className="border rounded-lg p-3">
                        <div className="font-bold text-sm mb-2">{p.squadra_casa} vs {p.squadra_trasferta}</div>
                        <div className="text-xs text-gray-600 mb-2">{p.data_partita}</div>
                        <div className="grid grid-cols-5 gap-1">
                          {p.quota_1 && <button onClick={() => aggiungiPartitaMultipla(p, '1', p.quota_1)} className="px-1 py-1 bg-green-500 text-white rounded text-xs">1<br/>{p.quota_1}</button>}
                          {p.quota_x && <button onClick={() => aggiungiPartitaMultipla(p, 'X', p.quota_x)} className="px-1 py-1 bg-gray-500 text-white rounded text-xs">X<br/>{p.quota_x}</button>}
                          {p.quota_2 && <button onClick={() => aggiungiPartitaMultipla(p, '2', p.quota_2)} className="px-1 py-1 bg-red-500 text-white rounded text-xs">2<br/>{p.quota_2}</button>}
                          {p.quota_gol && <button onClick={() => aggiungiPartitaMultipla(p, 'Gol', p.quota_gol)} className="px-1 py-1 bg-blue-500 text-white rounded text-xs">GOL<br/>{p.quota_gol}</button>}
                          {p.quota_over_25 && <button onClick={() => aggiungiPartitaMultipla(p, 'O2.5', p.quota_over_25)} className="px-1 py-1 bg-orange-500 text-white rounded text-xs">O2.5<br/>{p.quota_over_25}</button>}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {nuovaMultipla.partite_selezionate.length > 0 && (
                  <div className="p-4 bg-purple-50 border-2 border-purple-300 rounded-lg">
                    <h4 className="font-bold mb-3">üéØ Partite Selezionate ({nuovaMultipla.partite_selezionate.length})</h4>
                    <div className="space-y-2 mb-4">
                      {nuovaMultipla.partite_selezionate.map((p, i) => (
                        <div key={i} className="flex justify-between bg-white p-2 rounded-lg text-sm">
                          <div>
                            <div className="font-medium">{p.nome_partita}</div>
                            <div className="text-xs text-gray-600">{p.pronostico} - {p.quota}</div>
                          </div>
                          <button onClick={() => rimuoviPartitaMultipla(i)} className="px-2 bg-red-500 text-white rounded">‚úï</button>
                        </div>
                      ))}
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                      <div className="bg-white p-3 rounded-lg">
                        <div className="text-sm">Quota Totale</div>
                        <div className="text-2xl font-bold text-purple-600">{nuovaMultipla.partite_selezionate.reduce((acc, p) => acc * p.quota, 1).toFixed(2)}</div>
                      </div>
                      <div className="bg-white p-3 rounded-lg">
                        <div className="text-sm">Vincita Potenziale</div>
                        <div className="text-2xl font-bold text-green-600">‚Ç¨{nuovaMultipla.puntata ? (nuovaMultipla.partite_selezionate.reduce((acc, p) => acc * p.quota, 1) * parseFloat(nuovaMultipla.puntata)).toFixed(2) : '0.00'}</div>
                      </div>
                    </div>

                    <form onSubmit={creaMultipla} className="space-y-3">
                      <input type="text" value={nuovaMultipla.nome} onChange={(e) => setNuovaMultipla({...nuovaMultipla, nome: e.target.value})} placeholder="Nome multipla" className="w-full px-4 py-2 border rounded-lg" required />
                      <input type="number" step="0.01" value={nuovaMultipla.puntata} onChange={(e) => setNuovaMultipla({...nuovaMultipla, puntata: e.target.value})} placeholder="Puntata" className="w-full px-4 py-2 border rounded-lg" required />
                      <button type="submit" className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold">üé≤ Crea Multipla</button>
                    </form>
                  </div>
                )}
              </div>
            )}

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h3 className="text-xl font-bold mb-4">üìã Le Mie Multiple ({multiple.length})</h3>
              {multiple.length === 0 ? (
                <p className="text-center py-8 text-gray-500">Nessuna multipla</p>
              ) : (
                <div className="space-y-4">
                  {multiple.map(m => (
                    <div key={m.id} className="border-2 border-purple-200 rounded-lg p-4">
                      <div className="flex justify-between mb-3">
                        <h4 className="font-bold text-lg">{m.nome}</h4>
                        <span className={`px-3 py-1 rounded-full text-sm ${m.stato === 'win' ? 'bg-green-100 text-green-800' : m.stato === 'loss' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}`}>
                          {m.stato === 'win' ? '‚úì Vinta' : m.stato === 'loss' ? '‚úó Persa' : '‚è≥ Pending'}
                        </span>
                      </div>

                      <div className="grid grid-cols-4 gap-3 mb-4">
                        <div className="bg-purple-50 p-3 rounded-lg">
                          <div className="text-xs">Quota</div>
                          <div className="text-lg font-bold text-purple-600">{m.quota_totale.toFixed(2)}</div>
                        </div>
                        <div className="bg-blue-50 p-3 rounded-lg">
                          <div className="text-xs">Puntata</div>
                          <div className="text-lg font-bold text-blue-600">‚Ç¨{m.puntata.toFixed(2)}</div>
                        </div>
                        <div className="bg-green-50 p-3 rounded-lg">
                          <div className="text-xs">Vincita</div>
                          <div className="text-lg font-bold text-green-600">‚Ç¨{(m.quota_totale * m.puntata).toFixed(2)}</div>
                        </div>
                        <div className="bg-orange-50 p-3 rounded-lg">
                          <div className="text-xs">Profitto</div>
                          <div className="text-lg font-bold text-orange-600">‚Ç¨{m.guadagno_potenziale.toFixed(2)}</div>
                        </div>
                      </div>

                      <div className="border-t pt-3">
                        <h5 className="font-semibold mb-2">Partite ({m.multiple_partite?.length || 0}):</h5>
                        <div className="space-y-2">
                          {m.multiple_partite?.map((mp, i) => (
                            <div key={i} className="bg-gray-50 p-2 rounded text-sm">
                              <div className="font-medium">{mp.partite?.squadra_casa} vs {mp.partite?.squadra_trasferta}</div>
                              <div className="text-xs text-gray-600">{mp.pronostico} - Quota: {mp.quota}</div>
                            </div>
                          ))}
                        </div>
                      </div>

                      {isAdmin && m.stato === 'pending' && (
                        <div className="flex gap-2 mt-4">
                          <button onClick={() => aggiornaStatoMultipla(m.id, 'win')} className="px-4 py-2 bg-green-500 text-white rounded">Vinta</button>
                          <button onClick={() => aggiornaStatoMultipla(m.id, 'loss')} className="px-4 py-2 bg-red-500 text-white rounded">Persa</button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {tipoVista === 'budget' && (
          <div className="space-y-6">
            <div className="grid grid-cols-3 gap-6">
              <div className="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg shadow-lg p-6">
                <div className="text-sm opacity-90 mb-2">Saldo Attuale</div>
                <div className="text-4xl font-bold">‚Ç¨{budget.saldo.toFixed(2)}</div>
              </div>
              <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-lg p-6">
                <div className="text-sm opacity-90 mb-2">Pronostici</div>
                <div className="text-4xl font-bold">{pronostici.length}</div>
              </div>
              <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg shadow-lg p-6">
                <div className="text-sm opacity-90 mb-2">Multiple</div>
                <div className="text-4xl font-bold">{multiple.length}</div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h3 className="text-xl font-bold mb-4">üí≥ Gestisci Budget</h3>
              <form onSubmit={aggiungiMovimento} className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <select value={nuovoMovimento.tipo} onChange={(e) => setNuovoMovimento({...nuovoMovimento, tipo: e.target.value})} className="px-4 py-2 border rounded-lg">
                    <option value="deposito">üí∞ Deposito</option>
                    <option value="prelievo">üì§ Prelievo</option>
                  </select>
                  <input type="number" step="0.01" value={nuovoMovimento.importo} onChange={(e) => setNuovoMovimento({...nuovoMovimento, importo: e.target.value})} placeholder="Importo" className="px-4 py-2 border rounded-lg" required />
                </div>
                <input type="text" value={nuovoMovimento.descrizione} onChange={(e) => setNuovoMovimento({...nuovoMovimento, descrizione: e.target.value})} placeholder="Descrizione (opzionale)" className="w-full px-4 py-2 border rounded-lg" />
                <button type="submit" className={`w-full py-3 rounded-lg font-semibold text-white ${nuovoMovimento.tipo === 'deposito' ? 'bg-green-600' : 'bg-red-600'}`}>
                  {nuovoMovimento.tipo === 'deposito' ? 'üí∞ Deposito' : 'üì§ Prelievo'}
                </button>
              </form>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h3 className="text-xl font-bold mb-4">üìä Storico Movimenti</h3>
              {budget.movimenti.length === 0 ? (
                <p className="text-center py-8 text-gray-500">Nessun movimento</p>
              ) : (
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {budget.movimenti.map(m => (
                    <div key={m.id} className="flex justify-between p-3 bg-gray-50 rounded-lg">
                      <div>
                        <div className="font-medium">{m.descrizione}</div>
                        <div className="text-xs text-gray-500">{new Date(m.created_at).toLocaleString('it-IT')}</div>
                      </div>
                      <div className={`text-lg font-bold ${m.tipo === 'deposito' || m.tipo === 'vincita' ? 'text-green-600' : 'text-red-600'}`}>
                        {m.tipo === 'deposito' || m.tipo === 'vincita' ? '+' : '-'}‚Ç¨{m.importo.toFixed(2)}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {isAdmin && tipoVista === 'admin' && (
          <div className="space-y-6">
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4">‚öôÔ∏è Pannello Admin</h2>
              <div className="space-y-4">
                <button onClick={scaricaTemplate} className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold">üìÑ Scarica Template</button>
                <input type="file" accept=".tsv,.txt,.csv" onChange={(e) => e.target.files[0] && importaExcel(e.target.files[0])} className="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:bg-blue-50 file:text-blue-700" />
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>